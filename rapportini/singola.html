<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Singola</title>
        <link rel="stylesheet" href="assets/main.css">
        <style>
            .table{
                width: 100%;
                border-collapse: collapse;
                margin: 30px auto;
            }
            .small{
                width: 80% !important;
            }
            #container{
                margin: 0 auto;
                width: 50%;
            }
	        @media screen and (max-width: 1440px){
                #container{
                    width: 60%;
                }
            }
            @media screen and (max-width: 1100px){
                #container{
                    width: 75%;
                }
            }
        </style>
    </head>
    <body>
        <br><br>
        <h1 class="title">RAPPORTINO SINGOLA</h1>
        <!--HEADER-->
        <form method="POST" id="dataForm">
            <input size="40" name="NOME" placeholder="Inserisci il nome" required>
            <input name="DATA" type="date" required pattern="\d{4}-\d{2}-\d{2}" placeholder="aaaa-mm-gg">
            <select name="TURNO" id="turno" required>
                <option value="M">Mattino</option>
                <option value="P">Pomeriggio</option>
                <option value="N">Notte</option>
            </select>
            <div id="container">
                <table class="table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Densita vascone Engobbio</th>
                            <th>Densita vascone Smalto</th>
                            <th>Peso/Densita Produz. Engobbio</th>
                            <th>Peso/Densita Produz. Smalto</th>
                        </tr>
                    </thead>
                    <tbody> 
                        <tr>
                            <th>L1</th>
                            <td><input type="text" name="densita_engobbio_l1"></td>
                            <td><input type="text" name="densita_smalto_l1"></td>
                            <td><input type="text" name="pesodensita_engobbio_l1"></td>
                            <td><input type="text" name="pesodensita_smalto_l1"></td>
                        </tr>
		    </tbody>
                </table>
                <table class="table">
                    <thead>
                        <tr>
                            <th></th>
                            <th></th>
                            <th>Motivare</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>Smontato dischi smalto</th>
                            <td><input type="checkbox" name="smontato_dischismalto-check"></td>
                            <td><input type="text" name="smontato_dischismalto-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Smontato dischi discatura</th>
                            <td><input type="checkbox" name="smontato_dischidiscatura-check"></td>
                            <td><input type="text" name="smontato_dischidiscatura-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Cambi prodotto</th>
                            <td><input type="checkbox" name="cambiprodotto-check"></td>
                            <td><input type="text" name="cambiprodotto-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Controllo Spazzole</th>
                            <td><input type="checkbox" name="controllospazzole-check"></td>
                            <td><input type="text" name="controllospazzole-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Pulizia Programmata</th>
                            <td><input type="checkbox" name="puliziaprogram-check"></td>
                            <td><input type="text" name="puliziaprogram-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Prese Rotte</th>
                            <td><input type="checkbox" name="preserotte-check"></td>
                            <td><input type="text" name="preserotte-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Problemi Mastelli</th>
                            <td><input type="checkbox" name="problemimastelli-check"></td>
                            <td><input type="text" name="problemimastelli-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Problemi Digitale</th>
                            <td><input type="checkbox" name="problemidigitale-check"></td>
                            <td><input type="text" name="problemidigitale-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Problemi Cabine</th>
                            <td><input type="checkbox" name="problemicabine-check"></td>
                            <td><input type="text" name="problemicabine-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Problemi Linee e Curve</th>
                            <td><input type="checkbox" name="problineecurve-check"></td>
                            <td><input type="text" name="problineecurve-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Probl. Raddrizzatori</th>
                            <td><input type="checkbox" name="problraddrizzatori-check"></td>
                            <td><input type="text" name="problraddrizzatori-input" disabled></td>
                        </tr>
                        <tr>
                            <th>Intervento del Meccanico</th>
                            <td><input type="checkbox" name="interventomeccanico-check"></td>
                            <td><input type="text" name="interventomeccanico-input" disabled ></td>
                        </tr>
                    </tbody>
                </table>
                <table class="table small">
                    <tbody>
                        <tr>
                            <th>Temperatura uscita Essicatoio</th>
                            <td>L2:</td>
                            <td><input type="text" name="tempuscitaessicatoiol2"></td>
                            <td>L3:</td>
                            <td><input type="text" name="tempuscitaessicatoiol3"></td>
                        </tr>
                        <tr>
                            <th rowspan="2">Vuoti al forno</th>
                            <td>Dalle:</td>
                            <td><input type="time" name="from_time1"></td>
                            <td>Alle:</td>
                            <td><input type="time" name="to_time1"></td>
                        </tr>
                        <tr>
                            <td>Dalle:</td>
                            <td><input type="time" name="from_time2"></td>
                            <td>Alle:</td>
                            <td><input type="time" name="to_time2"></td>
                        </tr>
                    </tbody> 
                </table>
                <h3>Problemi Vari / Annotazioni</h3>
                <textarea class="small" name="comunicazioni" cols="30" rows="5"></textarea>
            </div>
            <input type="hidden" name="reparto" value="singola">
            <input type="submit" name="save" id="save" value="Salva">
            <button type="button" name="fine-turno" id="fine-turno" disabled>Fine Turno</button>
        </form>
        <script src="assets/script.js"></script>
        <script>
            var checkboxes = document.querySelectorAll('input[type=checkbox]');
            for(var j=0; j<checkboxes.length;j++){
                checkboxes[j].addEventListener('change', function(){
                    var name = this.name.split('-')[0];
                    if(this.checked){
                        document.getElementsByName(name+'-input')[0].removeAttribute("disabled");
                        document.getElementsByName(name+'-input')[0].setAttribute("required", "required");
                    }else{
                        document.getElementsByName(name+'-input')[0].setAttribute("disabled", "disabled");
                        document.getElementsByName(name+'-input')[0].removeAttribute("required");
                        document.getElementsByName(name+'-input')[0].value = "";
                    }
                });
            }
            
            document.addEventListener('DOMContentLoaded', function(){
                if(localStorage.singola){
                    var jsonSingolaDati = JSON.parse(localStorage.singola);
                    var storageKeys = Object.keys(jsonSingolaDati);
                    for(var k=0; k<storageKeys.length; k++){
                        //codice per oscurare gli input se non sono selezionate le checkbox
                        if(document.getElementsByName(storageKeys[k])[0].type=="checkbox"){
                            var checkbox = document.getElementsByName(storageKeys[k])[0]
                            var name = checkbox.name.split('-')[0];
                            checkbox.checked = jsonSingolaDati[storageKeys[k]];
                            if(checkbox.checked){
                                document.getElementsByName(name+'-input')[0].removeAttribute("disabled");
                                document.getElementsByName(name+'-input')[0].setAttribute("required", "required");
                            }else{
                                document.getElementsByName(name+'-input')[0].setAttribute("disabled", "disabled");
                                document.getElementsByName(name+'-input')[0].removeAttribute("required");
                            }
                        }else
                            document.getElementsByName(storageKeys[k])[0].value = jsonSingolaDati[storageKeys[k]];
                    }
                }
            });

            document.getElementById('dataForm').addEventListener('submit', function (event){
                event.preventDefault();
                saveToLocalStorage()
            });

            var btnCheckUnlock = setInterval(function(){
                if(localStorage.singola) var turno = JSON.parse(localStorage.singola)['TURNO']
                if(turno){
                    var date = new Date();
                    var timeNow = date.getHours() + ":" + date.getMinutes();
                    var timeNowDate= new Date("01/01/2000 " + timeNow);
                    var targetTime= new Date("01/01/2000 00:00");
                    switch(turno){
                        case 'M':
                            targetTime.setHours(11,30);
                            break;
                        case 'P':
                            targetTime.setHours(19,30);
                            break;
                        case 'N':
                            targetTime.setHours(3,30);
                            break
                    }
                    if(timeNowDate >= targetTime){
                        document.getElementById("fine-turno").removeAttribute("disabled")
                        document.getElementById("fine-turno").addEventListener("click", function(){
                            if(confirm("Vuoi inserire il rapportino nel database?\nVa inserito solo a fine turno"))
                                localStorageDataSend('singola');
                        });
                        clearInterval(btnCheckUnlock)
                    }
                }
            }, 1000);
        </script>
    </body>
</html>
